name: iOS Release (Capacitor)

on:
  workflow_dispatch:
    inputs:
      buildNumber:
        description: "Optional override for iOS build number (defaults to GitHub run number)"
        required: false
  push:
    branches:
      - main
    tags:
      - "v*"

env:
  NODE_VERSION: 20
  IOS_BUNDLE_ID: cloud.fasket.customer
  IOS_SCHEME: App
  IOS_WORKSPACE: ios/App/App.xcworkspace
  APP_VERSION: 1.0.0
  APP_NAME_EN: Fasket
  APP_NAME_AR: "فاسكت"

jobs:
  build-ios:
    runs-on: macos-14
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install npm dependencies
        run: npm ci

      - name: Build web assets
        run: npm run build

      - name: Add iOS platform (if missing) and sync assets
        run: |
          if [ ! -d ios ]; then
            npx cap add ios
          fi
          npx cap sync ios

      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods -N || true
          cd ios/App
          pod install

      - name: Apply iOS metadata (bundle id, names, versioning)
        env:
          BUILD_NUMBER_INPUT: ${{ github.event.inputs.buildNumber }}
          BUILD_NUMBER: ${{ github.run_number }}
        run: |
          PLIST=ios/App/App/Info.plist
          ENTITLEMENTS=ios/App/App/App.entitlements
          mkdir -p ios/App/App/en.lproj ios/App/App/ar.lproj

          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier $IOS_BUNDLE_ID" "$PLIST" || /usr/libexec/PlistBuddy -c "Add :CFBundleIdentifier string $IOS_BUNDLE_ID" "$PLIST"
          /usr/libexec/PlistBuddy -c "Set :aps-environment production" "$ENTITLEMENTS" || /usr/libexec/PlistBuddy -c "Add :aps-environment string production" "$ENTITLEMENTS"
          /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName $APP_NAME_EN" "$PLIST" || /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string $APP_NAME_EN" "$PLIST"
          /usr/libexec/PlistBuddy -c "Set :CFBundleName $APP_NAME_EN" "$PLIST" || /usr/libexec/PlistBuddy -c "Add :CFBundleName string $APP_NAME_EN" "$PLIST"
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $APP_VERSION" "$PLIST"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${BUILD_NUMBER_INPUT:-$BUILD_NUMBER}" "$PLIST"

          echo 'CFBundleDisplayName = "Fasket";' > ios/App/App/en.lproj/InfoPlist.strings
          echo 'CFBundleDisplayName = "فاسكت";' > ios/App/App/ar.lproj/InfoPlist.strings

      - name: Install signing assets
        env:
          IOS_CERT_P12_BASE64: ${{ secrets.IOS_CERT_P12_BASE64 }}
          IOS_CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
        run: |
          set -euo pipefail

          echo "$IOS_CERT_P12_BASE64" | base64 --decode > signing_cert.p12
          echo "$IOS_PROVISION_PROFILE_BASE64" | base64 --decode > profile.mobileprovision

          security create-keychain -p "" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "" build.keychain
          security import signing_cert.p12 -k build.keychain -P "$IOS_CERT_PASSWORD" -T /usr/bin/codesign
          security list-keychains -d user -s build.keychain $(security list-keychains -d user | tr -d '"')
          security default-keychain -d user -s build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

          PROFILE_UUID=$(grep -a -o '<UUID>[A-Z0-9-]*</UUID>' profile.mobileprovision | head -1 | sed -e 's/<UUID>//' -e 's/<\\/UUID>//')
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$PROFILE_UUID.mobileprovision

      - name: Build archive
        env:
          BUILD_NUMBER_INPUT: ${{ github.event.inputs.buildNumber }}
          BUILD_NUMBER: ${{ github.run_number }}
        run: |
          xcodebuild -workspace "$IOS_WORKSPACE" \
            -scheme "$IOS_SCHEME" \
            -configuration Release \
            -archivePath build/App.xcarchive \
            -destination 'generic/platform=iOS' \
            clean archive \
            PRODUCT_BUNDLE_IDENTIFIER="$IOS_BUNDLE_ID" \
            MARKETING_VERSION="$APP_VERSION" \
            CURRENT_PROJECT_VERSION="${BUILD_NUMBER_INPUT:-$BUILD_NUMBER}" \
            DEVELOPMENT_TEAM="${{ secrets.IOS_TEAM_ID }}" \
            PROVISIONING_PROFILE_SPECIFIER="${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}" \
            CODE_SIGN_STYLE=Manual

      - name: Export IPA
        run: |
          cat > ExportOptions.plist <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
            <key>teamID</key>
            <string>${{ secrets.IOS_TEAM_ID }}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${IOS_BUNDLE_ID}</key>
              <string>${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}</string>
            </dict>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath build/App.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build

      - name: Upload artifact (.ipa)
        uses: actions/upload-artifact@v4
        with:
          name: fasket-ios-ipa
          path: build/*.ipa

      - name: Upload to TestFlight (optional if API key secrets are set)
        if: ${{ secrets.ASC_KEY_ID != '' && secrets.ASC_ISSUER_ID != '' && secrets.ASC_PRIVATE_KEY_BASE64 != '' }}
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_PRIVATE_KEY_BASE64: ${{ secrets.ASC_PRIVATE_KEY_BASE64 }}
        run: |
          echo "$ASC_PRIVATE_KEY_BASE64" | base64 --decode > AuthKey.p8
          cat > fastlane_api_key.json <<EOF
          {
            "key_id": "$ASC_KEY_ID",
            "issuer_id": "$ASC_ISSUER_ID",
            "key": "$(cat AuthKey.p8)",
            "in_house": false
          }
          EOF

          fastlane pilot upload \
            --api_key_path fastlane_api_key.json \
            --ipa build/*.ipa \
            --skip_waiting_for_build_processing true
